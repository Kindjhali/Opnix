# Canvas Linking System

The Opnix canvas renders the live module graph and lets operators create or prune dependencies directly from the UI. This document outlines how linking works end-to-end.

## Data sources

1. **Auto-detected edges** – Generated by `services/moduleDetector.detectModules` from real import/require statements.
2. **Manual edges** – Captured through Cytoscape Edgehandles and persisted to `module-links.json` via the REST API.

Both sets are merged before the client renders the graph, ensuring that manual edits survive page reloads and coexist with automatic scans.

## Client interaction flow

1. The Vue client loads `/api/modules/graph` and caches `modules`, `edges`, and `summary`.
2. When the CANVAS tab first opens, `cytoscape-edgehandles` is initialised. Dragging from one node to another displays the edge handle overlay.
3. On release, the client calls `POST /api/modules/links` with `{ source, target }`.
4. Successful responses trigger a refresh through `/api/modules/detect`, so the canvas always reflects the authoritative merge of auto and manual dependencies.
5. Duplicate links skip re-creation and return `{ duplicate: true }`.

## API endpoints

| Endpoint | Method | Purpose |
| --- | --- | --- |
| `/api/modules/graph` | `GET` | Combined auto + manual edges (used for initial render). |
| `/api/modules/links` | `POST` | Persist a new manual dependency and timestamp. |
| `/api/modules/links` | `DELETE` | Remove an existing manual dependency (`{ source, target }`). |

Errors (missing modules, self-links) return HTTP 4xx codes with explanatory messages.

## Storage format

`module-links.json` contains a simple append-only array:

```json
[
  {
    "source": "frontend",
    "target": "backend",
    "createdAt": "2025-09-24T18:42:11.220Z"
  }
]
```

During detection, these relationships are folded into the dependency set before Cytoscape elements are generated.

## Canvas UI behaviour

- Node colour corresponds to health (derived from TODO count, coverage, and external dependency weight).
- Edge creation enforces `source !== target` guards.
- Layout toggles (`Tree`, `Circle`, `Force`) reuse the same graph data—only the layout algorithm changes.
- Exporting the canvas sends the rendered PNG to `/api/canvas/export`, which writes to `/exports` and exposes the download via `/api/exports`.

## Operational tips

- To seed links programmatically, write directly to `module-links.json` and call `/api/modules/detect` once.
- Remove stale edges with `DELETE /api/modules/links` prior to the next detection cycle.
- If drag-and-drop feels slow on huge graphs, consider filtering modules in the UI before linking.

This pipeline keeps the visual map aligned with the codebase by marrying static analysis with real-time manual curation.
